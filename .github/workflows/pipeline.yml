name: STM32H7 Dual-Core CI

on:
  push:
    branches: ["**"]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-firmware:
    runs-on: ubuntu-latest
    container:
      # Use lowercase manually here to satisfy Docker's requirements
      image: ghcr.io/makeydooey/stm32-builder:latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ${{ runner.os }}-ccache-${{ github.sha }}
          restore-keys: ${{ runner.os }}-ccache-

      - name: Style Check (Clang-Format)
        run: |
          echo "## ðŸŽ¨ Style Check" >> $GITHUB_STEP_SUMMARY
          find common/ cm7/ cm4/ -name "*.c" -o -name "*.h" | xargs clang-format --dry-run --Werror
          echo "âœ… Code style is consistent!" >> $GITHUB_STEP_SUMMARY

      - name: Static Analysis (Cppcheck)
        run: |
          echo "## ðŸ” Static Analysis Report" >> $GITHUB_STEP_SUMMARY
          cppcheck --enable=warning,performance,portability \
                   --inline-suppr --error-exitcode=1 \
                   common/ cm7/ cm4/ 2>&1 | tee cppcheck_output.txt || true
          echo '```text' >> $GITHUB_STEP_SUMMARY
          cat cppcheck_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Build Dual-Core Firmware
        run: make all -j$(nproc) OPT=small

      - name: Generate Build Summary
        if: always()
        run: |
          echo "## ðŸ“Š Build Size Report" >> $GITHUB_STEP_SUMMARY
          echo "### Core M7" >> $GITHUB_STEP_SUMMARY
          echo '```text' >> $GITHUB_STEP_SUMMARY
          [ -f build/cm7.elf ] && arm-none-eabi-size build/cm7.elf >> $GITHUB_STEP_SUMMARY || echo "M7 Build Failed" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          echo "### Core M4" >> $GITHUB_STEP_SUMMARY
          echo '```text' >> $GITHUB_STEP_SUMMARY
          [ -f build/cm4.elf ] && arm-none-eabi-size build/cm4.elf >> $GITHUB_STEP_SUMMARY || echo "M4 Build Failed" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          echo "### Cache Performance" >> $GITHUB_STEP_SUMMARY
          echo '```text' >> $GITHUB_STEP_SUMMARY
          ccache -s >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload Build Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: Nucleo-H755-Firmware-${{ github.ref_name }}
          path: |
            build/*.bin
            build/*.elf
