name: STM32H7 Dual-Core CI

on:
  push:
    branches: ["**"]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-firmware:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install ARM Toolchain
        uses: open-cmsis-pack/setup-arm-toolchain@v1

      - name: Install Project Dependencies
        run: |
          # Make all scripts in the subdirectory executable
          chmod +x scripts/dependencies/*.sh
          ./scripts/dependencies/dependencies_ci.sh

      - name: Check Code Style (clang-format)
        run: |
          echo "## ðŸŽ¨ Style Check" >> $GITHUB_STEP_SUMMARY
          find common/ cm7/ cm4/ -name "*.c" -o -name "*.h" | xargs clang-format --dry-run --Werror
          echo "âœ… Code style is consistent!" >> $GITHUB_STEP_SUMMARY

      - name: Run Static Analysis (Cppcheck)
        run: |
          echo "## ðŸ” Static Analysis Report" >> $GITHUB_STEP_SUMMARY
          cppcheck --enable=warning,performance,portability \
                   --inline-suppr \
                   --error-exitcode=1 \
                   common/ cm7/ cm4/ 2>&1 | tee cppcheck_output.txt || true
          echo '```text' >> $GITHUB_STEP_SUMMARY
          cat cppcheck_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Cache Build Objects
        uses: actions/cache@v4
        with:
          path: ~/.cache/ccache
          key: ${{ runner.os }}-ccache-${{ github.sha }}
          restore-keys: ${{ runner.os }}-ccache-

      - name: Build Dual-Core Firmware
        run: make all -j$(nproc) OPT=small

      - name: Generate Build Summary
        if: always()
        run: |
          echo "## ðŸ“Š Build Size Report" >> $GITHUB_STEP_SUMMARY
          echo "### Core M7" >> $GITHUB_STEP_SUMMARY
          echo '```text' >> $GITHUB_STEP_SUMMARY
          [ -f build/cm7.elf ] && arm-none-eabi-size build/cm7.elf >> $GITHUB_STEP_SUMMARY || echo "M7 Build Failed" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          echo "### Core M4" >> $GITHUB_STEP_SUMMARY
          echo '```text' >> $GITHUB_STEP_SUMMARY
          [ -f build/cm4.elf ] && arm-none-eabi-size build/cm4.elf >> $GITHUB_STEP_SUMMARY || echo "M4 Build Failed" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload Build Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: Nucleo-H755-Firmware-${{ github.ref_name }}
          path: |
            build/cm7.bin
            build/cm7.elf
            build/cm4.bin
            build/cm4.elf
